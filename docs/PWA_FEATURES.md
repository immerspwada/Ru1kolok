# Progressive Web App (PWA) Features

## Overview

The Sports Club Management System is a Progressive Web App (PWA) that provides native app-like experience with offline support, push notifications, and installability.

## Features Implemented

### 1. PWA Manifest and Service Worker

**Files:**
- `/public/manifest.json` - PWA manifest with app metadata
- Service worker automatically generated by `next-pwa`
- `/public/icons/` - App icons in multiple sizes

**Configuration:**
- App name: "Sports Club Management System"
- Theme color: #2563eb (blue)
- Display mode: standalone
- Orientation: portrait-primary

**Installation:**
- Users can install the app on mobile devices
- Install prompt appears automatically for eligible users
- Can be dismissed and will reappear after 7 days

### 2. Offline Data Caching

**Implementation:**
- IndexedDB-based storage for offline data
- Automatic caching of critical data (profile, sessions, announcements)
- Stale-while-revalidate strategy for optimal performance

**Cached Data:**
- User profile information
- Training sessions (6-hour cache)
- Announcements (1-hour cache)
- Attendance records
- Performance data

**Files:**
- `/lib/utils/offline-storage.ts` - IndexedDB utilities
- `/hooks/useOfflineData.ts` - React hook for offline data management

**Usage Example:**
```typescript
import { useOfflineProfile } from '@/hooks/useOfflineData';

const { data, isLoading, isOffline, error, refetch } = useOfflineProfile(
  userId,
  () => fetchProfileData(userId)
);
```

### 3. Offline Sync Mechanism

**Implementation:**
- Queue-based sync system for offline changes
- Automatic sync when connectivity is restored
- Retry logic with exponential backoff
- Conflict resolution for concurrent edits

**Supported Operations:**
- Check-in to training sessions
- Submit leave requests
- Mark attendance (coaches)
- Create/update records

**Files:**
- `/lib/utils/sync-queue.ts` - Sync queue management
- `/lib/utils/sync-manager.ts` - Sync orchestration
- `/lib/utils/offline-api.ts` - Offline-aware API calls
- `/hooks/useSync.ts` - React hook for sync status

**Usage Example:**
```typescript
import { offlinePost } from '@/lib/utils/offline-api';

// Automatically queues when offline
await offlinePost('/api/athlete/check-in', {
  sessionId,
  athleteId,
}, 'check-in');
```

### 4. Push Notifications

**Implementation:**
- Web Push API integration
- User subscription management
- Server-side subscription storage
- Notification preferences

**Features:**
- Real-time notifications for announcements
- Training session reminders
- Attendance updates
- Performance record notifications

**Files:**
- `/lib/utils/push-notifications.ts` - Push notification utilities
- `/hooks/usePushNotifications.ts` - React hook for push notifications
- `/components/ui/PushNotificationSettings.tsx` - Settings UI
- `/app/api/notifications/subscribe/route.ts` - Subscription API
- `/app/api/notifications/unsubscribe/route.ts` - Unsubscription API

**Database:**
- Table: `push_subscriptions`
- Stores user push subscriptions
- RLS policies for user privacy

**Usage Example:**
```typescript
import { usePushNotifications } from '@/hooks/usePushNotifications';

const { isSubscribed, subscribe, unsubscribe } = usePushNotifications(userId);

// Subscribe to push notifications
await subscribe();
```

## UI Components

### PWA Install Prompt
- Location: Bottom of screen (mobile) or bottom-right (desktop)
- Dismissible with 7-day cooldown
- Automatically appears for eligible users

### Offline Indicator
- Location: Top-right corner
- Shows when offline/online
- Auto-hides after 3 seconds when back online

### Sync Status Indicator
- Location: Bottom-right corner
- Shows pending sync operations
- Manual sync button when offline
- Progress indicator during sync

## Service Worker Caching Strategy

### Static Assets
- **Strategy:** CacheFirst
- **Cached:** Images, fonts, audio, video
- **Max Age:** 24 hours

### API Calls
- **Strategy:** NetworkFirst with 10s timeout
- **Fallback:** Cached response
- **Max Age:** 24 hours

### Next.js Data
- **Strategy:** StaleWhileRevalidate
- **Cached:** Pages, data, images
- **Max Age:** 24 hours

## Configuration

### Environment Variables

Required for push notifications:
```env
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_vapid_public_key
```

### Next.js Configuration

PWA is configured in `next.config.ts`:
```typescript
import withPWA from 'next-pwa';

export default withPWA({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  // ... runtime caching configuration
})(nextConfig);
```

## Testing

### Testing PWA Installation
1. Open the app in Chrome/Edge on mobile or desktop
2. Look for the install prompt
3. Click "Install" to add to home screen
4. Verify app opens in standalone mode

### Testing Offline Functionality
1. Open the app and navigate to a page
2. Open DevTools > Network tab
3. Set throttling to "Offline"
4. Navigate to cached pages - should work
5. Try to perform actions - should queue for sync
6. Go back online - should sync automatically

### Testing Push Notifications
1. Enable push notifications in settings
2. Grant notification permission
3. Send a test notification from admin panel
4. Verify notification appears

## Browser Support

### Supported Browsers
- Chrome/Edge 90+
- Safari 15.4+ (iOS 15.4+)
- Firefox 90+
- Samsung Internet 14+

### Feature Support
- **Service Worker:** All modern browsers
- **Push Notifications:** Chrome, Edge, Firefox (not Safari on iOS)
- **Install Prompt:** Chrome, Edge, Samsung Internet
- **IndexedDB:** All modern browsers

## Performance

### Metrics
- First Load: < 2s on 3G
- Time to Interactive: < 3s on 3G
- Offline Load: < 1s (from cache)

### Optimization
- Static assets cached aggressively
- API responses cached with stale-while-revalidate
- Images optimized with Next.js Image component
- Code splitting for faster initial load

## Security

### Service Worker
- HTTPS required for service worker
- Same-origin policy enforced
- Content Security Policy headers

### Push Notifications
- User permission required
- Subscriptions stored securely in database
- RLS policies prevent unauthorized access

### Offline Storage
- IndexedDB data isolated per origin
- No sensitive data stored offline
- Automatic cleanup of stale data

## Troubleshooting

### PWA Not Installing
- Ensure HTTPS is enabled
- Check manifest.json is accessible
- Verify service worker is registered
- Check browser console for errors

### Offline Mode Not Working
- Clear browser cache and reload
- Check service worker is active
- Verify IndexedDB is not disabled
- Check browser storage quota

### Push Notifications Not Working
- Verify VAPID keys are configured
- Check notification permission is granted
- Ensure service worker is active
- Check browser supports push notifications

### Sync Not Working
- Check network connectivity
- Verify sync queue has pending operations
- Check browser console for errors
- Try manual sync button

## Future Enhancements

### Planned Features
1. **Background Sync API** - Sync even when app is closed
2. **Periodic Background Sync** - Automatic data refresh
3. **Share Target API** - Share content to the app
4. **Badging API** - Show unread count on app icon
5. **Native File System API** - Direct file access

### Performance Improvements
1. Implement service worker precaching
2. Add predictive prefetching
3. Optimize cache strategies per route
4. Implement cache versioning

## References

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [next-pwa Documentation](https://github.com/shadowwalker/next-pwa)
